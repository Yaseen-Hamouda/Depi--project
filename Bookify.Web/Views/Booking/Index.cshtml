@model IEnumerable<Bookify.Core.Models.Booking>
@{
    ViewData["Title"] = "Bookings Management";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />

<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 fw-bold text-primary">
                <i class="fas fa-calendar-alt me-2"></i>Bookings Management
            </h1>
            <p class="text-muted mb-0">View and manage all bookings in the system</p>
        </div>
        <a asp-action="Create" class="btn btn-success btn-lg">
            <i class="fas fa-plus-circle me-2"></i>Create New Booking
        </a>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-primary text-uppercase mb-1">
                                Total Bookings
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">@Model.Count()</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar fa-2x text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-success text-uppercase mb-1">
                                Total Revenue
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">
                                $@Model.Sum(b => b.TotalPrice).ToString("N2")
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-warning text-uppercase mb-1">
                                Active Bookings
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">
                                @Model.Count(b => b.CheckInDate <= DateTime.Now && b.CheckOutDate >= DateTime.Now)
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-bed fa-2x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-info text-uppercase mb-1">
                                Avg. Booking Value
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">
                                $@(Model.Any() ? Model.Average(b => b.TotalPrice).ToString("N2") : "0.00")
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-line fa-2x text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Table Card -->
    <div class="card shadow-lg border-0">
        <div class="card-header bg-white py-3">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold">
                    <i class="fas fa-list-alt me-2"></i>All Bookings
                </h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm" id="filterAll">All</button>
                    <button type="button" class="btn btn-outline-success btn-sm" id="filterActive">Active</button>
                    <button type="button" class="btn btn-outline-warning btn-sm" id="filterUpcoming">Upcoming</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="filterPast">Past</button>
                </div>
            </div>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="bookingsTable">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">
                                <i class="fas fa-user me-1"></i>User
                            </th>
                            <th>
                                <i class="fas fa-bed me-1"></i>Room
                            </th>
                            <th>
                                <i class="fas fa-sign-in-alt me-1"></i>Check-In
                            </th>
                            <th>
                                <i class="fas fa-sign-out-alt me-1"></i>Check-Out
                            </th>
                            <th>
                                <i class="fas fa-moon me-1"></i>Nights
                            </th>
                            <th>
                                <i class="fas fa-dollar-sign me-1"></i>Total Price
                            </th>
                            <th>
                                <i class="fas fa-tag me-1"></i>Status
                            </th>
                            <th class="text-end pe-4">
                                <i class="fas fa-cogs me-1"></i>Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var booking in Model)
                        {
                            var nights = (booking.CheckOutDate - booking.CheckInDate).Days;
                            var isActive = booking.CheckInDate <= DateTime.Now && booking.CheckOutDate >= DateTime.Now;
                            var isUpcoming = booking.CheckInDate > DateTime.Now;
                            var isPast = booking.CheckOutDate < DateTime.Now;

                            <tr class="@(isActive ? "table-success" : isUpcoming ? "table-warning" : "")">
                                <td class="ps-4 fw-bold">
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-circle-sm bg-primary text-white me-3">
                                            @booking.UserId.ToString().Substring(0, 1).ToUpper()
                                        </div>
                                        <div>
                                            <div>User @booking.UserId</div>
                                            <small class="text-muted">ID: @booking.UserId</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="fw-bold">Room @booking.RoomId</div>
                                    <small class="text-muted">Booking ID: @booking.Id</small>
                                </td>
                                <td>
                                    <div class="fw-bold">@booking.CheckInDate.ToString("dd MMM yyyy")</div>
                                    <small class="text-muted">@booking.CheckInDate.DayOfWeek</small>
                                </td>
                                <td>
                                    <div class="fw-bold">@booking.CheckOutDate.ToString("dd MMM yyyy")</div>
                                    <small class="text-muted">@booking.CheckOutDate.DayOfWeek</small>
                                </td>
                                <td>
                                    <span class="badge bg-info rounded-pill px-3 py-2">
                                        <i class="fas fa-moon me-1"></i>@nights nights
                                    </span>
                                </td>
                                <td>
                                    <div class="fw-bold text-success">$@booking.TotalPrice.ToString("N2")</div>
                                    <small class="text-muted">@(nights > 0 ? $"${(booking.TotalPrice / nights):N2}/night" : "")</small>
                                </td>
                                <td>
                                    @{
                                        var statusClass = booking.PaymentStatus?.ToLower() switch
                                        {
                                            "paid" => "success",
                                            "pending" => "warning",
                                            "cancelled" => "danger",
                                            "refunded" => "info",
                                            _ => "secondary"
                                        };
                                    }
                                    <span class="badge bg-@statusClass rounded-pill px-3 py-2">
                                        <i class="fas fa-circle me-1 small"></i>
                                        @booking.PaymentStatus
                                    </span>
                                </td>
                                <td class="text-end pe-4">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a asp-action="Details" asp-route-id="@booking.Id"
                                           class="btn btn-outline-info"
                                           data-bs-toggle="tooltip"
                                           title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a asp-action="Edit" asp-route-id="@booking.Id"
                                           class="btn btn-outline-warning"
                                           data-bs-toggle="tooltip"
                                           title="Edit Booking">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a asp-action="Delete" asp-route-id="@booking.Id"
                                           class="btn btn-outline-danger"
                                           data-bs-toggle="tooltip"
                                           title="Delete Booking"
                                           onclick="return confirm('Are you sure you want to delete this booking?')">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        }

                        @if (!Model.Any())
                        {
                            <tr>
                                <td colspan="8" class="text-center py-5">
                                    <div class="empty-state">
                                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                                        <h5 class="text-muted">No bookings found</h5>
                                        <p class="text-muted">Create your first booking to get started</p>
                                        <a asp-action="Create" class="btn btn-primary mt-2">
                                            <i class="fas fa-plus me-1"></i>Create Booking
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-footer bg-white py-3">
            <div class="d-flex justify-content-between align-items-center">
                <div class="text-muted small">
                    Showing <strong>@Model.Count()</strong> bookings
                </div>
                <div>
                    <button class="btn btn-outline-secondary btn-sm" onclick="exportToExcel()">
                        <i class="fas fa-file-excel me-1"></i>Export
                    </button>
                    <button class="btn btn-outline-secondary btn-sm ms-2" onclick="window.print()">
                        <i class="fas fa-print me-1"></i>Print
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        $(document).ready(function() {
            // Initialize DataTable
            const table = $('#bookingsTable').DataTable({
                pageLength: 10,
                lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
                order: [[2, 'asc']], // Sort by Check-In date by default
                language: {
                    search: "_INPUT_",
                    searchPlaceholder: "Search bookings...",
                    lengthMenu: "Show _MENU_ entries",
                    info: "Showing _START_ to _END_ of _TOTAL_ entries",
                    paginate: {
                        first: "First",
                        last: "Last",
                        next: "Next",
                        previous: "Previous"
                    }
                }
            });

            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            });

            // Filter buttons functionality
            $('#filterAll').on('click', function() {
                table.search('').columns().search('').draw();
                updateActiveFilter($(this));
            });

            $('#filterActive').on('click', function() {
                table.column(1).search('').draw();
                updateActiveFilter($(this));
            });

            $('#filterUpcoming').on('click', function() {
                table.search('upcoming').draw();
                updateActiveFilter($(this));
            });

            $('#filterPast').on('click', function() {
                table.search('past').draw();
                updateActiveFilter($(this));
            });

            function updateActiveFilter(button) {
                $('.btn-group .btn').removeClass('active');
                button.addClass('active');
            }

            // Export to Excel function
            window.exportToExcel = function() {
                const data = table.data().toArray();
                let csvContent = "data:text/csv;charset=utf-8,";

                // Add headers
                csvContent += "User,Room,Check-In,Check-Out,Nights,Total Price,Status\r\n";

                // Add data
                data.forEach(row => {
                    csvContent += row.join(",") + "\r\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "bookings.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // Auto-refresh every 30 seconds if needed
            // setInterval(function() {
            //     table.ajax.reload(null, false);
            // }, 30000);
        });
    </script>

    <style>
        .avatar-circle-sm {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05);
            transform: translateY(-1px);
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .empty-state {
            opacity: 0.7;
        }

        .badge {
            font-weight: 500;
        }

        .card {
            border-radius: 15px;
            overflow: hidden;
        }

        .card-header {
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .border-left-primary {
            border-left: 4px solid #4e73df !important;
        }

        .border-left-success {
            border-left: 4px solid #1cc88a !important;
        }

        .border-left-warning {
            border-left: 4px solid #f6c23e !important;
        }

        .border-left-info {
            border-left: 4px solid #36b9cc !important;
        }

        .btn-group .btn.active {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }

        .dataTables_wrapper {
            padding: 0 1rem;
        }

        .dataTables_length,
        .dataTables_filter {
            margin: 1rem 0;
        }

        media print {
            .btn, .btn-group, .card-header .btn-group

        {
            display: none !important;
        }

        .table {
            border: 1px solid #dee2e6;
        }

            .table th {
                background-color: #f8f9fa !important;
                color: #000 !important;
            }

        }
    </style>
}